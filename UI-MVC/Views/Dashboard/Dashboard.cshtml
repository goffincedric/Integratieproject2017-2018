@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section styles{

    <link href="~/Content/Styling/grid2/gridstack.css" rel="stylesheet" />
    <link href="~/Content/Styling/grid2/gridstack-extra.css" rel="stylesheet" />
    <style type="text/css">

        #grid1 {
            <!-- border: 3px solid black; -->
            padding: 3px;
            margin-bottom: 10px;
        }

        #grid2 {
            <!-- border: 3px solid red; -->
            margin-top: 5px;
        }

        .grid-stack-item-content {
            color: #2c3e50;
            text-align: center;
            background-color: #18bc9c;
        }

        #grid2 .grid-stack-item-content {
            background-color: grey;
        }

        #grid1 .grid-stack-item-content {
            background-color: grey;
        }
    </style>
}

<main class="main-content bgc-grey-100">
    <div id="mainContent">
        @foreach (var zone in Model.Zones)
        {
            <div class="p-10 mB-10">
                <h4 class="bb-2">@zone.Title<span class="arrow-dashboard"><i class="ti-angle-up"></i></span></h4>
                <div class="dashboard">
                    <div style="margin-bottom:5px" class="buttons">
                        <a class="btn btn-default load-grid" id="load-grid" href="#">Load Grid</a>
                        <a class="btn btn-default clear-grid" id="clear-grid" href="#">Clear Grid</a>
                        <a class="btn btn-default add-element" id="add-element" href="#">Add Element</a>
                    </div>
                    <div class="grid-stack grid-stack-12" id="zone-@zone.ZoneId">
                    </div>
                </div>
            </div>
        }
    </div>
</main>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.5.0/lodash.min.js"></script>

<script src="~/Scripts/grid2/gridstack.js"></script>
<script src="~/Scripts/grid2/gridstack.jQueryUI.js"></script>

<script type="text/javascript">
    let Headers = { "x-api-key": "303d22a4-402b-4d3c-b279-9e81c0480711"};

    //api call working
    var DashData = "";

    DashData = $.ajax({
        async: false,
        type: 'GET',
        dataType: 'json',
        headers: Headers,
        url: "https://localhost:44342/api/dashboard/getdashboardzones/" + @Model.DashboardId
    }).responseJSON;

    $(function () {
        var options = {
            width: 12,
            animate: true,
            float: true,
            removable: '.trash',
            removeTimeout: 100,
            acceptWidgets: '.grid-stack-item'
        };
        $('.grid-stack').gridstack(options);

        new function () {
            findElements = function (id) {
                var ZoneData = $.ajax({
                    async: false,
                    type: 'GET',
                    dataType: 'json',
                    headers: Headers,
                    url: "https://localhost:44342/api/dashboard/getzoneelements/" + id
                }).responseJSON;

                return ZoneData;
            };

            //done
            addElement = function (grid) {
                var ZoneId = grid.attr('id');
                ZoneId = ZoneId.substring(ZoneId.indexOf('-') + 1, ZoneId.length);

                var Element = JSON.parse('{"X" : "0", "Y" : "0", "Width": "2", "Height": "2", "IsDraggable": "true", "ZoneId": "' + ZoneId + '"}');

                $.ajax({
                    async: false,
                    type: 'POST',
                    data: Element,
                    dataType: 'json',
                    headers: Headers,
                    url: "https://localhost:44342/api/dashboard/postelement/" + ZoneId
                })

                loadGrid(grid);
            }

            changeElements = function (elements, grid) {
                var ZoneId = grid.attr('id');
                ZoneId = ZoneId.substring(ZoneId.indexOf('-') + 1, ZoneId.length);

                for (var e in elements) {
                    var element = elements[e];

                    var ElementId = element.el.children('div').attr('id');
                    ElementId = ElementId.substring(ElementId.indexOf('-') + 1, ElementId.length);

                    var Element = JSON.parse('{"ElementId":"' + ElementId +'", "X" : "' + element.x + '", "Y" : "' + element.y + '", "Width": "' + element.width + '", "Height": "' + element.height + '", "IsDraggable": "' + !element.noMove +'", "ZoneId": "' + ZoneId + '"}');

                    $.ajax({
                        async: false,
                        type: 'PUT',
                        data: Element,
                        dataType: 'json',
                        headers: Headers,
                        url: "https://localhost:44342/api/dashboard/putelement/" + ElementId
                    })
                }
            }

            //done
            clearGrid = function (grid) {
                grid.removeAll();
                return false;
            }.bind(this);

            //almost done
            loadGrid = function (grid) {
                clearGrid(grid.data('gridstack'));
                var ZoneId = grid.attr('id');
                ZoneId = ZoneId.substring(ZoneId.indexOf('-') + 1, ZoneId.length);
                var elements = findElements(ZoneId);

                grid.each(function () {
                    var grid = $(this).data('gridstack');

                    //this for now(change later), Gets correct data from database
                    _.each(elements, function (node) {
                        grid.addWidget($('<div><div class="grid-stack-item-content bgc-white bd" id="Element-' + node.ElementId + '"/><div/>'),
                            node.X, node.Y, node.Width, node.Height);
                    }, this);
                });
            }

            $(".grid-stack").each(function () {
                this.grid = $(this).data('gridstack');

                loadGrid($(this));

                //loading and adding graphs
                $(this).siblings('.buttons').children('.load-grid').on("click", function () {
                    this.grid = $(this).parent().siblings('.grid-stack').data('gridstack');
                    loadGrid($(this).parent().siblings('.grid-stack'));
                });

                //Clearing Zone/Grid done
                $(this).siblings('.buttons').children('.clear-grid').on("click", function () {
                    this.grid = $(this).parent().siblings('.grid-stack').data('gridstack');
                    clearGrid(this.grid);
                });

                //working
                $(this).siblings('.buttons').children('.add-element').on("click", function () {
                    addElement($(this).parent().siblings('.grid-stack'))
                });

                $(this).on('change', function (e, items) {
                    changeElements(items, $(this));
                });
            });
        };
    });
</script>

@Scripts.Render("~/bundles/DashboardControl")